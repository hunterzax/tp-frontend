# üìå ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç - CWE-284: Broken Access Control

## ‚ö†Ô∏è ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç CRITICAL

‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Access Control ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô**‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏£‡∏∞‡∏î‡∏±‡∏ö CRITICAL ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î** ‡∏ó‡∏µ‡πà‡∏û‡∏ö‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö  
‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥**‡∏ó‡∏±‡∏ô‡∏ó‡∏µ**‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏¢‡πà‡∏≤‡∏á**‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°** ‡∏°‡∏¥‡∏â‡∏∞‡∏ô‡∏±‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡πÇ‡∏à‡∏°‡∏ï‡∏µ

---

## üéØ ‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)

### ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà 1: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ù‡∏±‡πà‡∏á Server ‡πÄ‡∏•‡∏¢
**‡∏õ‡∏±‡∏ç‡∏´‡∏≤:** ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏≥‡∏ó‡∏µ‡πà‡∏ù‡∏±‡πà‡∏á Client (Browser) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô  
**‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢:** ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î Developer Console ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç JavaScript ‡∏´‡∏£‡∏∑‡∏≠ localStorage ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡∏Å‡∏±‡πâ‡∏ô‡πÑ‡∏î‡πâ

**‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏à‡∏°‡∏ï‡∏µ:**
```javascript
// ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡∏¥‡∏î Console ‡πÅ‡∏•‡πâ‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå:
localStorage.setItem("o8g4z3q9f1v5e2n7k6t", btoa(JSON.stringify([
    "/en/authorization/dam/userManagement/users",
    "/en/authorization/dam/parameters/systemParameter"
])));
location.reload();
// ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ!
```

### ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà 2: Permissions ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô localStorage
**‡∏õ‡∏±‡∏ç‡∏´‡∏≤:** ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡πá‡∏ö permissions ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô localStorage (key: `k3a9r2b6m7t0x5w1s8j`)  
**‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏ü‡∏•‡πå:** 120 ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ä‡πâ pattern ‡∏ô‡∏µ‡πâ (799 ‡∏à‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö permissions ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)  
**‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢:** ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç localStorage ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ

**‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏à‡∏°‡∏ï‡∏µ:**
```javascript
// ‡πÉ‡∏´‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á:
const adminPerms = {
    role_config: {
        f_view: 1, f_create: 1, f_edit: 1, f_import: 1,
        f_export: 1, f_approved: 1, f_noti_inapp: 1, f_noti_email: 1
    }
};
localStorage.setItem("k3a9r2b6m7t0x5w1s8j", encryptData(JSON.stringify(adminPerms)));
location.reload();
// ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: ‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏° Create, Edit, Delete, Export ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏õ‡∏£‡∏≤‡∏Å‡∏è!
```

### ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà 3: Middleware ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡∏¢
**‡∏õ‡∏±‡∏ç‡∏´‡∏≤:** `middleware.ts` ‡∏°‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏Ñ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏†‡∏≤‡∏©‡∏≤ ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö token ‡∏´‡∏£‡∏∑‡∏≠ permissions  
**‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢:** ‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ token ‡∏Å‡πá‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á URL ‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á

### ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà 4: API Routes ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô
**‡∏õ‡∏±‡∏ç‡∏´‡∏≤:** API endpoints ‡πÄ‡∏ä‡πà‡∏ô `/api/webservice` ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà  
**‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢:** ‡πÉ‡∏Ñ‡∏£‡∏Å‡πá‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏ú‡πà‡∏≤‡∏ô Postman/curl ‡πÑ‡∏î‡πâ

**‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:**
```bash
# ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á login ‡∏Å‡πá‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÑ‡∏î‡πâ:
curl http://localhost:3000/api/webservice
# ‡∏Ñ‡∏ß‡∏£‡πÑ‡∏î‡πâ 401 Unauthorized ‡πÅ‡∏ï‡πà‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•!
```

---

## üö® ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö

### ‡∏î‡πâ‡∏≤‡∏ô‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à:
- üî¥ **‡∏£‡∏±‡πà‡∏ß‡πÑ‡∏´‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:** ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Gas Metering ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ
- üî¥ **‡∏Å‡∏≤‡∏£‡∏•‡∏∞‡πÄ‡∏°‡∏¥‡∏î Compliance:** ‡∏ù‡πà‡∏≤‡∏ù‡∏∑‡∏ô GDPR, SOC 2, ISO 27001
- üî¥ **‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢:** ‡∏≠‡∏≤‡∏à‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏±‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏ü‡πâ‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏á
- üî¥ **‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢:** ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÇ‡∏à‡∏°‡∏ï‡∏µ‡∏à‡∏∞‡∏™‡πà‡∏á‡∏ú‡∏•‡∏ï‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠

### ‡∏î‡πâ‡∏≤‡∏ô‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ:
- üî¥ **Bypass ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:** ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡∏£‡∏∞‡∏ö‡∏ö Access Control ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
- üî¥ **‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå:** ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤‡πÄ‡∏õ‡πá‡∏ô Admin ‡πÑ‡∏î‡πâ
- üî¥ **‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ:** ‡∏ú‡∏π‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÑ‡∏î‡πâ
- üî¥ **‡πÑ‡∏°‡πà‡∏°‡∏µ Audit Trail:** ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÉ‡∏Ñ‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏î‡πâ

---

## üìã ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ

### ‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏∏‡∏î (‡πÅ‡∏Å‡πâ‡∏Å‡πà‡∏≠‡∏ô):
```
1. /src/middleware.ts                    - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö JWT Token
2. /src/utils/checkRestrictedPage.tsx    - ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÄ‡∏õ‡πá‡∏ô fallback ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
3. /src/app/api/webservice/route.ts      - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö permissions
4. /src/app/api/notifications/route.ts   - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö permissions
```

### ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (120 ‡πÑ‡∏ü‡∏•‡πå):
- ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏∏‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ `localStorage.getItem("k3a9r2b6m7t0x5w1s8j")`
- ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏∏‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ `generateUserPermission()`
- ‡πÑ‡∏ü‡∏•‡πå component ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ `userPermission?.f_view`, `userPermission?.f_create` ‡∏Ø‡∏•‡∏Ø

---

## ‚úÖ ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á

### ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏û‡∏¥‡πà‡∏° Server-Side Authentication ‡πÉ‡∏ô Middleware

**‡πÑ‡∏ü‡∏•‡πå:** `/src/middleware.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { jwtVerify } from 'jose';

export async function middleware(req: NextRequest) {
    const pathname = req.nextUrl.pathname;
    
    // ‡∏Ç‡πâ‡∏≤‡∏° public routes
    if (pathname.includes('/signin') || pathname.includes('/_next')) {
        return NextResponse.next();
    }
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö protected routes
    if (pathname.includes('/authorization')) {
        const token = req.cookies.get('v4r2d9z5m3h0c1p0x7l')?.value;
        
        if (!token) {
            // ‡πÑ‡∏°‡πà‡∏°‡∏µ token -> redirect ‡πÑ‡∏õ login
            return NextResponse.redirect(new URL('/en/signin', req.url));
        }
        
        try {
            // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö JWT Token ‡∏ö‡∏ô Server
            const secret = new TextEncoder().encode(process.env.JWT_SECRET);
            const { payload } = await jwtVerify(token, secret);
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (payload.exp && payload.exp < Date.now() / 1000) {
                return NextResponse.redirect(new URL('/en/signin', req.url));
            }
            
            // ‚úÖ Pass user info ‡πÑ‡∏õ‡∏¢‡∏±‡∏á API routes
            const response = NextResponse.next();
            response.headers.set('x-user-id', payload.sub || '');
            response.headers.set('x-user-role', payload.role || '');
            return response;
            
        } catch (error) {
            // Token ‡πÑ‡∏°‡πà valid -> redirect ‡πÑ‡∏õ login
            return NextResponse.redirect(new URL('/en/signin', req.url));
        }
    }
    
    return NextResponse.next();
}

export const config = {
    matcher: ['/((?!_next|api/public|favicon.ico).*)'],
};
```

### ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏™‡∏£‡πâ‡∏≤‡∏á API Permission Middleware

**‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà:** `/src/utils/apiAuthMiddleware.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { jwtVerify } from 'jose';

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö wrap API routes ‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
export function withAuth(
    handler: (req: NextRequest, user: any) => Promise<NextResponse>,
    config: { requiredPermission?: string, requiredRole?: string[] } = {}
) {
    return async (req: NextRequest) => {
        // ‡∏î‡∏∂‡∏á token ‡∏à‡∏≤‡∏Å header ‡∏´‡∏£‡∏∑‡∏≠ cookie
        const authHeader = req.headers.get('Authorization');
        const token = authHeader?.replace('Bearer ', '') || 
                     req.cookies.get('v4r2d9z5m3h0c1p0x7l')?.value;
        
        if (!token) {
            return NextResponse.json(
                { error: 'Unauthorized - No token provided' },
                { status: 401 }
            );
        }
        
        try {
            // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö JWT Token
            const secret = new TextEncoder().encode(process.env.JWT_SECRET);
            const { payload } = await jwtVerify(token, secret);
            
            // ‚úÖ ‡∏î‡∏∂‡∏á permissions ‡∏à‡∏≤‡∏Å Database/Redis (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà localStorage!)
            const userPermissions = await fetchUserPermissionsFromDB(payload.sub);
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö required permission
            if (config.requiredPermission) {
                const hasPermission = userPermissions[`f_${config.requiredPermission}`];
                if (!hasPermission) {
                    return NextResponse.json(
                        { error: 'Forbidden - Insufficient permissions' },
                        { status: 403 }
                    );
                }
            }
            
            // ‚úÖ Pass user info ‡πÑ‡∏õ‡∏¢‡∏±‡∏á handler
            const user = {
                id: payload.sub,
                role: payload.role,
                permissions: userPermissions,
            };
            
            return handler(req, user);
            
        } catch (error) {
            return NextResponse.json(
                { error: 'Unauthorized - Invalid token' },
                { status: 401 }
            );
        }
    };
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á permissions ‡∏à‡∏≤‡∏Å Database
async function fetchUserPermissionsFromDB(userId: string) {
    // ‚ö†Ô∏è TODO: ‡∏ï‡πâ‡∏≠‡∏á implement ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å database ‡∏à‡∏£‡∏¥‡∏á
    // ‡∏´‡πâ‡∏≤‡∏°‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å localStorage!
    
    // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:
    // const result = await db.query(
    //     `SELECT p.* FROM user_permissions p
    //      JOIN users u ON u.id = p.user_id
    //      WHERE u.id = ?`,
    //     [userId]
    // );
    
    return {
        f_view: true,
        f_create: false,
        f_edit: false,
        // ...
    };
}
```

### ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô API Routes

**‡πÑ‡∏ü‡∏•‡πå:** `/src/app/api/webservice/route.ts`

```typescript
import { NextRequest, NextResponse } from "next/server";
import { withAuth } from '@/utils/apiAuthMiddleware';

// ‚úÖ ‡πÉ‡∏ä‡πâ withAuth wrapper ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô endpoint
export const GET = withAuth(
    async (req: NextRequest, user: any) => {
        // ‚úÖ user ‡∏ñ‡∏π‡∏Å authenticate ‡πÅ‡∏•‡πâ‡∏ß ‡∏°‡∏µ permission ‡πÅ‡∏•‡πâ‡∏ß
        
        try {
            const ACCESS_TOKEN = process.env.TPA_ACCESS_TOKEN ?? "";
            const JWT_COOKIE = process.env.TPA_JWT_COOKIE ?? "";
            
            const upstream = await fetch(
                "https://tpasystem-pre.pttplc.com/TPA_WEBCONFIG_UAT/Manage/AllMeter",
                {
                    headers: {
                        "access-token": ACCESS_TOKEN,
                        Cookie: `jwt_token=${JWT_COOKIE}`,
                    },
                }
            );
            
            // ‚úÖ ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà CORS wildcard ‡∏î‡πâ‡∏ß‡∏¢ whitelist
            const resHeaders = new Headers();
            const origin = req.headers.get('origin');
            const allowedOrigins = process.env.ALLOWED_ORIGINS?.split(',') || [];
            if (origin && allowedOrigins.includes(origin)) {
                resHeaders.set("Access-Control-Allow-Origin", origin);
            }
            
            // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å audit log
            await logApiAccess({
                userId: user.id,
                endpoint: '/api/webservice',
                method: 'GET',
                timestamp: new Date(),
            });
            
            return new NextResponse(upstream.body, {
                status: upstream.status,
                headers: resHeaders,
            });
        } catch (err: any) {
            return NextResponse.json(
                { error: "Service unavailable" }, // ‡πÑ‡∏°‡πà leak error details
                { status: 500 }
            );
        }
    },
    {
        requiredPermission: 'view', // ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ f_view permission
    }
);
```

### ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 4: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Client Components

**‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà:**
```typescript
// ‚ùå ‡πÄ‡∏Å‡πà‡∏≤ - ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢
let user_permission: any = localStorage?.getItem("k3a9r2b6m7t0x5w1s8j");
user_permission = user_permission ? decryptData(user_permission) : null;
```

**‡∏î‡πâ‡∏ß‡∏¢:**
```typescript
// ‚úÖ ‡πÉ‡∏´‡∏°‡πà - ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
const [userPermission, setUserPermission] = useState<any>(null);

useEffect(() => {
    const fetchPermissions = async () => {
        try {
            // ‚úÖ ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å API ‡∏ó‡∏µ‡πà validate ‡∏î‡πâ‡∏ß‡∏¢ server
            const response = await fetch('/api/auth/permissions', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                },
            });
            
            if (response.ok) {
                const data = await response.json();
                setUserPermission(data.permissions);
                
                // Cache ‡πÉ‡∏ô localStorage ‡πÄ‡∏û‡∏∑‡πà‡∏≠ UX (‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà trust ‡∏°‡∏±‡∏ô)
                localStorage.setItem(
                    'cached_permissions',
                    encryptData(JSON.stringify(data.permissions))
                );
            }
        } catch (error) {
            console.error('Failed to fetch permissions');
        }
    };
    
    fetchPermissions();
}, [token]);
```

---

## üìÖ ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (4 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå)

### ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà 1: Foundation
- [ ] ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1-2: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç middleware ‡πÄ‡∏û‡∏¥‡πà‡∏° JWT validation
- [ ] ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 3-4: ‡∏™‡∏£‡πâ‡∏≤‡∏á API auth middleware utility
- [ ] ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 5: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô API routes ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç

### ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà 2: API Protection  
- [ ] ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1-2: ‡∏™‡∏£‡πâ‡∏≤‡∏á `/api/auth/permissions` endpoint
- [ ] ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 3-4: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô API routes ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
- [ ] ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 5: ‡∏ó‡∏≥ audit logging system

### ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà 3: Client Updates
- [ ] ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1-2: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á permissions ‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å page
- [ ] ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 3-4: ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç bugs
- [ ] ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 5: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á

### ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà 4: Testing & Deploy
- [ ] ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1-2: Security testing + penetration testing
- [ ] ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 3: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö
- [ ] ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 4: UAT ‡∏Å‡∏±‡∏ö test users
- [ ] ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 5: Deploy production ‡∏û‡∏£‡πâ‡∏≠‡∏° monitoring

---

## üß™ ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö

### Checklist ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢:
```
‚ñ° ‡∏ó‡∏î‡∏™‡∏≠‡∏ö middleware block ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ token
‚ñ° ‡∏ó‡∏î‡∏™‡∏≠‡∏ö JWT token validation (valid, expired, invalid)
‚ñ° ‡∏ó‡∏î‡∏™‡∏≠‡∏ö permissions ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å server ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà localStorage
‚ñ° ‡∏ó‡∏î‡∏™‡∏≠‡∏ö permission enforcement ‡πÉ‡∏ô API routes ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
‚ñ° ‡∏ó‡∏î‡∏™‡∏≠‡∏ö CORS restrictions ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
‚ñ° ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (privilege escalation)
‚ñ° ‡∏ó‡∏î‡∏™‡∏≠‡∏ö audit logging ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
‚ñ° ‡∏ó‡∏î‡∏™‡∏≠‡∏ö session timeout
‚ñ° ‡∏ó‡∏î‡∏™‡∏≠‡∏ö rate limiting
```

### Penetration Testing Scenarios:
```
1. Bypass localStorage: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç localStorage -> ‡∏ï‡πâ‡∏≠‡∏á access denied
2. Token manipulation: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç JWT claims -> ‡∏ï‡πâ‡∏≠‡∏á validation failed  
3. Direct API access: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á -> ‡∏ï‡πâ‡∏≠‡∏á 401 Unauthorized
4. Permission escalation: ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå -> ‡∏ï‡πâ‡∏≠‡∏á 403 Forbidden
5. CORS bypass: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å domain ‡∏≠‡∏∑‡πà‡∏ô -> ‡∏ï‡πâ‡∏≠‡∏á CORS error
```

---

## ‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á

### ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà ‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏≥:
- ‚ùå ‡∏≠‡∏¢‡πà‡∏≤‡∏û‡∏∂‡πà‡∏á‡∏û‡∏≤ localStorage ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
- ‚ùå ‡∏≠‡∏¢‡πà‡∏≤‡∏Ñ‡∏¥‡∏î‡∏ß‡πà‡∏≤ encryption ‡πÉ‡∏ô localStorage ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (‡∏¢‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ)
- ‚ùå ‡∏≠‡∏¢‡πà‡∏≤‡∏ó‡∏≥ authentication/authorization ‡∏ù‡∏±‡πà‡∏á client ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
- ‚ùå ‡∏≠‡∏¢‡πà‡∏≤ comment out ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏ß‡πâ (‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÄ‡∏•‡∏¢)
- ‚ùå ‡∏≠‡∏¢‡πà‡∏≤‡πÉ‡∏ä‡πâ wildcard `*` ‡πÉ‡∏ô CORS
- ‚ùå ‡∏≠‡∏¢‡πà‡∏≤ leak error details ‡πÉ‡∏´‡πâ user ‡πÄ‡∏´‡πá‡∏ô

### ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥:
- ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ù‡∏±‡πà‡∏á server
- ‚úÖ ‡πÉ‡∏ä‡πâ JWT tokens ‡∏ó‡∏µ‡πà‡∏°‡∏µ expiration
- ‚úÖ ‡∏î‡∏∂‡∏á permissions ‡∏à‡∏≤‡∏Å database/Redis
- ‚úÖ ‡∏ó‡∏≥ audit logging ‡∏ó‡∏∏‡∏Å API call
- ‚úÖ ‡πÉ‡∏ä‡πâ HTTPS ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (production)
- ‚úÖ ‡∏ó‡∏≥ rate limiting ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô brute force
- ‚úÖ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î

---

## üìö ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á

### ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô:
- [README.md](./README.md) - ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏ï‡πá‡∏° (‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)
- [CWE-284-ISSUES.csv](./CWE-284-ISSUES.csv) - ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

### ‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å:
- [OWASP A01:2021 - Broken Access Control](https://owasp.org/Top10/A01_2021-Broken_Access_Control/)
- [CWE-284: Improper Access Control](https://cwe.mitre.org/data/definitions/284.html)
- [Next.js Middleware Docs](https://nextjs.org/docs/app/building-your-application/routing/middleware)

---

## üÜò ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠

‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠:
- ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ [README.md](./README.md) ‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏ï‡πá‡∏°‡∏Å‡πà‡∏≠‡∏ô
- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö [CWE-284-ISSUES.csv](./CWE-284-ISSUES.csv) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞ issue

---

**‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢:** Claude AI (Sonnet 4.5) - Security Audit Engine  
**‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:** 29 ‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏° 2025  
**‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:** üî¥ **CRITICAL - ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏±‡∏ô‡∏ó‡∏µ**

